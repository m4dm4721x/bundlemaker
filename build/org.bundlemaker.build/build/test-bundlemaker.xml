<project name="test-bundlemaker"
         basedir="."
         default="test-bundlemaker"
         xmlns:ant4eclipse="antlib:org.ant4eclipse"
         xmlns:antcontrib="antlib:net.sf.antcontrib"
         xmlns:clover="antlib:com.cenqua.clover">

	<!-- import common build definitions -->
	<import file="${basedir}/common-definitions.xml" />

	<!-- ================================= 
          target: test-bundlemaker              
         ================================= -->
	<target name="test-bundlemaker">

		<!-- clean the clover coverage database -->
		<clover:clover-clean />

		<!-- clean the 'tests' directory -->
		<delete dir="${basedir}/../destination/tests" quiet="true" />
		<mkdir dir="${basedir}/../destination/tests" />

		<!-- clean the 'coverage' directory -->
		<delete dir="${basedir}/../destination/coverage" quiet="true" />
		<mkdir dir="${basedir}/../destination/coverage" />

		<!-- instrument and build the workspace -->
		<instrumentAndBuildWorkspace />

		<!-- execute the tests -->
		<executeTests />

		<!-- create the html-report -->
		<clover:clover-html-report outdir="${basedir}/../destination/coverage"
		                           title="BundleMaker Coverage Report" />

		<!-- create the html-report -->
		<clover:clover-pdf-report outfile="${basedir}/../destination/coverage.pdf"
		                          title="BundleMaker Coverage Report" />


		<!-- clean up the instrumented tasks -->
		<cleanUp />

	</target>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: instrumentAndBuildWorkspace          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="instrumentAndBuildWorkspace">
		<sequential>

			<!-- iterate over all projects in the workspace -->
			<ant4eclipse:executeProjectSet workspaceId="bundleMakerWorkspaceWithTests"
			                               allWorkspaceProjects="true"
			                               resolveBuildOrder="true">

				<!-- execute the contained build steps for all plug-in projects -->
				<ant4eclipse:forEachProject filter="(executeProjectSet.org.eclipse.pde.PluginNature=*)">

					<!-- Step 1: clean all output directories -->
					<ant4eclipse:executeJdtProject workspaceId="bundleMakerWorkspaceWithTests"
					                               projectName="${executeProjectSet.project.name}"
					                               prefix="buildPlugin"
					                               targetPlatformId="target.platform">

						<ant4eclipse:forEachOutputDirectory>
							<delete dir="${buildPlugin.output.directory}"
							        quiet="true" />
							<mkdir dir="${buildPlugin.output.directory}" />
						</ant4eclipse:forEachOutputDirectory>

					</ant4eclipse:executeJdtProject>
				</ant4eclipse:forEachProject>

				<!-- Step 2: call the build plug-in project -->
				<ant4eclipse:forEachProject filter="(executeProjectSet.org.eclipse.pde.PluginNature=*)">

					<!-- Step 2.1: instrument the 'main' projects -->
					<antcontrib:if>
						<matches pattern=".*[\\/]main[\\/].*"
						         string="${executeProjectSet.project.directory}" />
						<antcontrib:then>
							<ant4eclipse:cloverInstr workspaceId="bundleMakerWorkspaceWithTests"
							                         projectName="${executeProjectSet.project.name}" />
						</antcontrib:then>
					</antcontrib:if>

					<!-- Step 2.2: build the projects -->
					<buildPlugin workspaceId="bundleMakerWorkspaceWithTests"
					             projectname="${executeProjectSet.project.name}"
					             targetPlatformId="target.platform"
					             destination="${basedir}/destination"
					             debug="false"
					             skipPackage="true" />

				</ant4eclipse:forEachProject>

			</ant4eclipse:executeProjectSet>
		</sequential>
	</macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: executeTests          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="executeTests">
		<sequential>

			<!-- define the clover path -->
			<path id="clover.path">
				<pathelement location="${basedir}/../libs/clover-ant/clover.jar" />
			</path>

			<!-- iterate over all projects in the workspace -->
			<ant4eclipse:executeProjectSet workspaceId="bundleMakerWorkspaceWithTests"
			                               allWorkspaceProjects="true"
			                               resolveBuildOrder="false">

				<!-- execute the contained build steps for all plug-in projects -->
				<ant4eclipse:forEachProject filter="(executeProjectSet.org.eclipse.pde.PluginNature=*)">

					<echo>${executeProjectSet.project.directory}/[${executeProjectSet.project.name}] </echo>

					<antcontrib:if>
						<available file="${executeProjectSet.project.directory}/[${executeProjectSet.project.name}] Test All.launch"
						           type="file" />
						<antcontrib:then>

							<!-- echo -->
							<echo>Launching "${executeProjectSet.project.directory}/[${executeProjectSet.project.name}] Test All.launch"</echo>

							<!-- execute the PdeJunitLauncher -->
							<executePdeJunitLauncher workspaceId="bundleMakerWorkspaceWithTests"
							                         targetPlatformId="target.platform"
							                         projectName="${executeProjectSet.project.name}"
							                         launchConfigurationFile="${executeProjectSet.project.directory}/[${executeProjectSet.project.name}] Test All.launch"
							                         targetDirectory="${basedir}/../destination/tests"
							                         tempDir="${basedir}/temp"
							                         additionalClassPathRefId="clover.path" />

						</antcontrib:then>
					</antcontrib:if>

				</ant4eclipse:forEachProject>

			</ant4eclipse:executeProjectSet>

		</sequential>
	</macrodef>

	<macrodef name="cleanUp">
		<sequential>

			<!-- iterate over all projects in the workspace -->
			<ant4eclipse:executeProjectSet workspaceId="bundleMakerWorkspaceWithTests"
			                               allWorkspaceProjects="true"
			                               resolveBuildOrder="false">

				<!-- execute the contained build steps for all plug-in projects -->
				<ant4eclipse:forEachProject filter="(executeProjectSet.org.eclipse.pde.PluginNature=*)">

					<ant4eclipse:cloverCleanUp workspaceId="bundleMakerWorkspaceWithTests"
					                           projectName="${executeProjectSet.project.name}" />

					<!-- STEP 1: clean all output directories -->
					<ant4eclipse:executeJdtProject workspaceId="bundleMakerWorkspaceWithTests"
					                               projectName="${executeProjectSet.project.name}"
					                               prefix="cleanUp"
					                               targetPlatformId="target.platform">

						<ant4eclipse:forEachOutputDirectory>
							<delete dir="${cleanUp.output.directory}"
							        quiet="true" />
							<mkdir dir="${cleanUp.output.directory}" />
						</ant4eclipse:forEachOutputDirectory>

					</ant4eclipse:executeJdtProject>
				</ant4eclipse:forEachProject>

			</ant4eclipse:executeProjectSet>
		</sequential>
	</macrodef>

</project>