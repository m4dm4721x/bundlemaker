<project name="deploy-bundlemaker"
         basedir="."
         default="deploy-bundlemaker"
         xmlns:ant4eclipse="antlib:org.ant4eclipse"
         xmlns:antcontrib="antlib:net.sf.antcontrib">

	<!-- Ant4Eclipse (http://www.ant4eclipse.org) -->
	<taskdef uri="antlib:org.ant4eclipse" resource="org/ant4eclipse/antlib.xml">
		<classpath>
			<fileset dir="${basedir}/../libs/ant4eclipse">
				<include name="org.ant4eclipse_*.jar" />
			</fileset>
			<fileset dir="${basedir}/../libs/ant4eclipse/libs">
				<include name="org.eclipse.osgi_*.jar" />
				<include name="ecj-*.jar" />
			</fileset>
		</classpath>
	</taskdef>

	<!-- AntContrib (http://ant-contrib.sourceforge.net/) -->
	<typedef resource="net/sf/antcontrib/antlib.xml"
	         uri="antlib:net.sf.antcontrib"
	         classpath="${basedir}/../libs/ant4eclipse/libs/ant-contrib-1.0b3.jar" />

	<!-- import a4e-pde-macros.xml -->
	<import file="${basedir}/../libs/ant4eclipse/macros/a4e-pde-macros.xml" />

	<!-- set properties -->
	<property file="${basedir}/build.properties" />

	<!-- define some helper propertiess -->
	<property name="bundlemaker-workspace" value="${basedir}/../.." />
	<property name="bundlemaker-deploy-dir" value="${basedir}/../destination" />

	<!-- define the ant4eclipse target platform -->
	<ant4eclipse:targetPlatform id="target.platform">
		<location dir="${bundlemaker-workspace}/target.platform/bundlor-1.0.0.RELEASE" />
		<location dir="${bundlemaker-workspace}/target.platform/drools-5.1.1" />
		<location dir="${bundlemaker-workspace}/target.platform/emf-2.6.1" />
		<location dir="${bundlemaker-workspace}/target.platform/slf4j-1.5.10" />
		<location dir="${bundlemaker-workspace}/target.platform/xtext" />
		<location dir="${eclipse.install.dir}" />
	</ant4eclipse:targetPlatform>

	<ant4eclipse:workspaceDefinition id="myWorkspace">
		<dirset dir="${bundlemaker-workspace}">
			<include name="*" />
			<exclude name=".git" />
		</dirset>
	</ant4eclipse:workspaceDefinition>

	<!-- ================================= 
          target: deploy-bundlemaker              
         ================================= -->
	<target name="deploy-bundlemaker">

		<echo>Deploy bundlemaker to '${bundlemaker-deploy-dir}'</echo>

		<!-- step 1: export bundlemaker -->
		<delete dir="${bundlemaker-deploy-dir}/bundlemaker" quiet="true" />
		<mkdir dir="${bundlemaker-deploy-dir}/bundlemaker" />

		<buildFeature workspaceId="myWorkspace"
		              projectName="org.bundlemaker.core.feature"
		              targetPlatformId="target.platform"
		              destination="${bundlemaker-deploy-dir}/bundlemaker"
		              clearDestination="true"
		              defaultCompilerOptionsFile="${basedir}/org.eclipse.jdt.core.preferences" />

		<!-- -->
		<createP2Repo eclipseDir="${eclipse.install.dir}"
		              repositoryDir="${bundlemaker-deploy-dir}/bundlemaker"
		              categoryDefinition="${basedir}/bundlemaker-category.xml" />

	</target>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: createP2Repo          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="createP2Repo">
		<attribute name="eclipseDir" />
		<attribute name="repositoryDir" />
		<attribute name="categoryDefinition" />
		<sequential>

			<!-- store path to newest launcher JAR in path id 'newest.equinox.launcher.path.id' -->
			<path id="newest.equinox.launcher.path.id">
				<first count="1">
					<sort>
						<fileset dir="@{eclipseDir}/plugins"
						         includes="**/org.eclipse.equinox.launcher_*.jar" />
						<!-- Seems the default order is oldest > newest so we must reverse it.
						The 'reverse' and 'date' comparators are in the internal antlib
						org.apache.tools.ant.types.resources.comparators.
						-->
						<reverse xmlns="antlib:org.apache.tools.ant.types.resources.comparators">
							<!-- 'date' inherits 'reverse's namespace -->
							<date />
						</reverse>
					</sort>
				</first>
			</path>

			<!-- turn the path into a property -->
			<property name="equinox.launcher.jar.location"
			          refid="newest.equinox.launcher.path.id" />

			<!-- -->
			<java failonerror="true"
			      fork="true"
			      jar="${equinox.launcher.jar.location}">
				<arg value="-consolelog" />
				<arg value="-application" />
				<arg value="org.eclipse.equinox.p2.publisher.FeaturesAndBundlesPublisher" />
				<arg value="-metadataRepository" />
				<arg value="file://@{repositoryDir}" />
				<arg value="-artifactRepository" />
				<arg value="file://@{repositoryDir}" />
				<arg value="-source" />
				<arg value="@{repositoryDir}" />
				<arg value="-compress" />
			</java>

			<!-- -->
			<java failonerror="true"
			      fork="true"
			      jar="${equinox.launcher.jar.location}">
				<arg value="-consolelog" />
				<arg value="-application" />
				<arg value="org.eclipse.equinox.p2.publisher.CategoryPublisher" />
				<arg value="-metadataRepository" />
				<arg value="file://@{repositoryDir}" />
				<arg value="-categoryDefinition" />
				<arg value="file://@{categoryDefinition}" />
				<arg value="-compress" />
			</java>

		</sequential>
	</macrodef>

</project>